generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id              String        @id @default(cuid())
  clerkId         String        @unique
  email           String        @unique
  name            String?
  role            Role          @default(PENDING)
  languages       String[]
  preferences     Json?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  image           String?
  bids            Bid[]
  chatHistory     ChatHistory[]
  following       Follows[]     @relation("follower")
  followedBy      Follows[]     @relation("following")
  forumLikes      ForumLike[]
  forumPosts      ForumPost[]
  orders          Order[]
  products        Product[]
  profile         Profile?
  reviewsReceived Review[]      @relation("ReceivedReviews")
  reviewsWritten  Review[]      @relation("WrittenReviews")
  stories         Story[]
}

model Profile {
  id                String  @id @default(cuid())
  userId            String  @unique
  businessName      String?
  craftType         String?
  bio               String?
  location          String?
  state             String?
  yearsOfExperience Int?
  city              String?
  country           String? @default("India")
  phoneNumber       String?
  pincode           String?
  streetAddress     String?
  user              User    @relation(fields: [userId], references: [id])
}

model Product {
  id          String       @id @default(cuid())
  title       String
  description String
  price       Float
  category    String
  materials   String[]
  images      String[]
  stock       Int          @default(1)
  tags        String[]
  views       Int          @default(0)
  salesCount  Int          @default(0)
  artisanId   String
  createdAt   DateTime     @default(now())
  auction     AuctionItem?
  orderItems  OrderItem[]
  artisan     User         @relation(fields: [artisanId], references: [id])
}

model Order {
  id         String      @id @default(cuid())
  total      Float
  status     String      @default("PENDING")
  customerId String
  createdAt  DateTime    @default(now())
  customer   User        @relation(fields: [customerId], references: [id])
  items      OrderItem[]
}

model OrderItem {
  id        String  @id @default(cuid())
  orderId   String
  productId String
  quantity  Int
  price     Float
  order     Order   @relation(fields: [orderId], references: [id])
  product   Product @relation(fields: [productId], references: [id])
}

model AuctionItem {
  id           String        @id @default(cuid())
  productId    String        @unique
  basePrice    Float
  reservePrice Float?
  currentBid   Float         @default(0)
  startTime    DateTime      @default(now())
  endTime      DateTime
  status       AuctionStatus @default(ACTIVE)
  product      Product       @relation(fields: [productId], references: [id])
  bids         Bid[]
}

model Bid {
  id        String      @id @default(cuid())
  amount    Float
  timestamp DateTime    @default(now())
  userId    String
  auctionId String
  auction   AuctionItem @relation(fields: [auctionId], references: [id])
  user      User        @relation(fields: [userId], references: [id])
}

model ChatHistory {
  id       String @id @default(cuid())
  messages Json
  userId   String
  user     User   @relation(fields: [userId], references: [id])
}

model Story {
  id                String   @id @default(cuid())
  title             String
  content           String
  createdAt         DateTime @default(now())
  category          String   @default("Artisan Spotlights")
  excerpt           String
  author            String   @default("The Artisan's Loom")
  featuredArtisanId String
  heroImage         String?
  featuredArtisan   User     @relation(fields: [featuredArtisanId], references: [id])
}

model ForumPost {
  id        String      @id @default(cuid())
  content   String
  tags      String[]
  flagged   Boolean     @default(false)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  userId    String
  parentId  String?
  likes     ForumLike[]
  parent    ForumPost?  @relation("PostReplies", fields: [parentId], references: [id], onDelete: Cascade)
  children  ForumPost[] @relation("PostReplies")
  user      User        @relation(fields: [userId], references: [id])
}

model ForumLike {
  id     String    @id @default(cuid())
  postId String
  userId String
  post   ForumPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  user   User      @relation(fields: [userId], references: [id])

  @@unique([postId, userId])
}

model Follows {
  followerId  String
  followingId String
  follower    User   @relation("follower", fields: [followerId], references: [id])
  following   User   @relation("following", fields: [followingId], references: [id])

  @@id([followerId, followingId])
}

model Review {
  id        String   @id @default(cuid())
  rating    Int
  comment   String
  createdAt DateTime @default(now())
  authorId  String
  artisanId String
  artisan   User     @relation("ReceivedReviews", fields: [artisanId], references: [id])
  author    User     @relation("WrittenReviews", fields: [authorId], references: [id])
}

enum Role {
  ARTISAN
  CUSTOMER
  ADMIN
  PENDING
}

enum AuctionStatus {
  ACTIVE
  SOLD
  UNSOLD
}
